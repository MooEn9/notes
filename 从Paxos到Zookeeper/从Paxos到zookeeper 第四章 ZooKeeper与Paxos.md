# ZooKeeper与Paxos



Zookeeper 为分布式应用提供了高效且可靠的分布式协调服务（如统一的命名服务、配置管理、分布式锁...），在解决分布式数据一致性方面，没有直接采用Paxos算法，而是采用了ZAB(ZooKeeper Atomic Broadcast)的一致性协议。

1. 初识Zookeeper

   * __Zookeeper介绍__：Zookeeper识一个开源的分布式协调服务，由雅虎创建，识Google Chubby的开源实现，旨在将复杂容易出错的分布式一致性服务封装起来，构成一个高效的原语集，并对用户提供简单调用的接口。

   * __ZooKeeper是什么__：它是一个分布式数据一致性的解决方案，分布式应用程序能基于它实现诸如数据发布/订阅、负载均衡、命名服务、分布式协调服务、集群管理、分布式锁、分布式队列等功能。Zookeeper可以保证如下分布式特性：

     * __顺序一致性__：同一个客户端发起的事务请求，最终将会严格的按照发起顺序被用到Zookeeper
     * __原子性__：所有的事物处理结果在整个集群中所有机器的应用情况都是一样的。
     * __单一视图__：无论客户端接的是哪台Zookeeper服务器，看到的服务器数据模型都是一致的。
     * __可靠性__：一旦服务端成功应用了一个事务，并对客户端响应，那么该事务所引起的服务器状态变更将会一致保留下来，除非另一个事物对其进行了变更。
     * __实时性__：不同于平常理解实时性，zookeeper仅仅保证在一定时间段内，客户端一定能从服务端读到最新数据。

   * __zookeeper的设计目标__：致力于提供一个高性能、高可用、具有严格顺序访问的分布式协调服务。

     * 目标一：__简单的数据模型__ Zookeeper使得分布式程序能通过一个_**共享的**_、_**树形结构**_的名字空间来进行相互协调。这里的名字空间指的是Zookeeper服务器内存中的一个数据模型，其由一系列的ZNode组成，总的来说其数据模型类似一个文件系统。
     * 目标二：__可以构建集群__  每台集群中的机器都会维护当前服务器状态，只有当集群中机器数量超过一半是集群才能正常对外提供服务。
     * 目标三：__顺序访问__  对于来自客户端的每个更新请求，Zookeeper都会分配一个_**全局唯一的递增编号**_，这个编号反映了实务操作的先后顺序。
     * 目标四：__高性能__  由于Zookeeper将全量数据存储在内存中，并直接服务于客户端的所有非事务请求，因此它尤其适合以读操作为主的应用场景。

   * __Zookeeper的基本概念__：

     * __集群角色__ ：没有采用传统的Master/Slave，而是引入了全新的Leader、Follower和Observer。leader由选举产生能为客户端提供读写服务、Follower和Observe都能提供读服务，唯一的差别是Observe不参与写操作的过程，也不参与"过半写成功"。

     * __会话(Session)__ ：客户端与服务器建立TCP长连接，客户端能够通过心跳检测和服务端建立有效的会话，通过该连接接受服务器的watch时间通知，能设置Session中的SessionTimeout值设置客户端会话的超时时间。由于各种原因客户端断开了连接，只要在sessionTimout时间内连上任意一台服务器之前的会话依然有效。

     * __数据节点(ZNode)__：Zookeeper中的节点分为两类，一类是构成集群的节点称为__机器节点__,一类是数据模型中的数据单元，称为__数据节点——Znode__,Zookeeper的所有数据都存储在内存中，数据模型是一棵树(Znode Tree)由斜杠进行分割的路径，就是一个Znode，如/foo/path1。每个ZNode上都会保存自己的数据内容，同时还会保存一系列属性信息。ZNode又可以分为__持久节点__和__临时节点__，持久节点指一旦ZNode被创建，除非主动进行ZNode的移除操作，否则这个ZNode将一直保存在Zookeeper上，而临时节点的生命周期和客户端会话绑定，一旦客户端会话失效，这个客户端创建的所有临时节点都会被移除。同时Zookeeper还允许用户为每个节点添加一个特殊的属性：__SEQUENTIAL(时序的、相继的)属性__，一旦被加上这个属性，那么在这个节点被创建的时候，Zookeeper会自动在其节点上最佳上一个整形数字，这个整形数字就是一个由__父节点__维护得自增数字。

     * __版本__：Zookeeper的每个ZNode上都会存储数据，对于每个Znode，Zookeeper都会为其维护一个Stat的数据结构，Stat中记录了这个ZNode的__三个数据版本__ version（当前ZNode的版本）、cversion(当前ZNode子节点的版本)和aversion（当前ZNode的ACL版本）

     * __Watcher（时间监听器）__Zookeeper允许用户在指定节点注册Watcher，当一些特定的事件触发时，Zookeeper服务端会将事件通知到感兴趣的客户端上去。

     * __ACL(Access Control Lists: 访问控制列表)__：5类权限：

       __CREATE__：创建子节点）

       __READ__：获取节点数据和子节点列表）

       __WRITE__：更新节点

       __DELETE__：删除子节点

       __ADMIN__：设置节点ACL

       __其中Create和Delete都是针对子节点的权限控制。__

       