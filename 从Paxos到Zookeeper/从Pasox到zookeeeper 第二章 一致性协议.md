## 从Pasox到zookeeeper 第二章 一致性协议

1. __2PC__（Two-Phase Commit，两阶段提交，协调者与参与者）

   * 二阶段提交协议被认为是一种一致性协议，用于保证分布式系统数据的一致性，绝大多数的关系型数据库都是使用了2pc模式。

   * 两阶段提交，将提交过程分为了两个阶段来进行处理

     阶段一：提交事务请求

     1. 事务询问：协调者向所有的参与者发送事务呢容，询问是否可以执行事务提交，并等待参与者的响应。
     2. 执行事务：参与者节点执行事务，保留Undo和Redo信息
     3. 参与者向协调者反馈事务询问的相应（Yes，No）。

       由于形似协调者对事务组织投票，也别称为投票阶段

     阶段二：执行事务提交

     1. 发送提交请求：协调者向所有的参与者发出Commit请求。
     2. 事务提交：参与者收到commit请求后执行事务提交操作，并在完成后释放资源。
     3. 反馈事务提交的结果：完成事务提交后向协调则发送ACK消息。
     4. 完成事务：协调者收所有参与者的ack消息后完成事务。

     可能出现中断事务，如果有一个参与者发送了No响应，或者协调者等待超时，就会启动中断事务：

     1. 协调者向参与者发送回滚请求。
     2. 参与者接到回滚请求之后依据undo信息执行回滚，并释放资源。
     3. 反馈事务回滚结果：参与者完成事务的回滚后发送Ack消息。
     4. 中断事务：协调者接受所有参与者的ack消息后，完成事务中断

     2pc：投票->执行,对每个事务都采用先尝试后提交，可以理解为强一致性。

     2pc优点：原理简单，实现方便。

     缺点：同步阻塞（协调者等待响应、参与者等待commit）、单点问题（过于依赖协调者）、脑裂（数据不一致，由于网络问题等，在协调者发送commit消息后有些节点无法收到commit，这就造成了数据不一致）、保守（只依靠超时机制判断是否需要中断事务）。

2. __3PC__ （Three-Phase Commit：三阶段提交）

   * 3PC是2PC的改进版：将2pc中的提交事务请求过程一分为二，形成了由CanCommit、PreCommit、do Commit,三个阶段组成的事务处理协议。

     阶段一：CanCommit

     1. 事务询问：协调者向所有参与者发送cancommit请求，等待响应
     2. 参与者反馈：在收到canCommit请求之后，若自身可以顺利执行返回yes响应，进入预备状态，否则反馈no响应

     阶段二：PreCommit

     执行事务预提交：若所有的参与则都反馈yes，就执行预提交

     1. 发送预提交请求后，并进入Prepared阶段
     2. 事务预提交：参与者收到precmomit请求后执行事务操作，将Undo和Redo信息记录到事务日志中。
     3. 各参与者协调者反馈事务的响应：弱成功执行了事务操作，就会反馈给协调者Ack响应，同时等待最终的指令：提交（commit）或中止（abort）

     中断事务：加入由参与者节点反馈了NO，或者协调者等待超时，那就中断事务。

     1. 向参与者节点发送中断（abort）请求
     2. 中断事务：无论是收到abort请求还是等待协调者超时，参与者都会中断事务。

     阶段三：doCommit（真正的事务提交，有两种情况）

     执行提交：

     1. 发送提交请求，协调者接受了所有参与者的ack请求后，从预提交状态转换为提交状态，并向参与者发送doCommit请求。
     2. 事务提交：参与者接受docommit请求后执行事务提交，并在完成后释放占用的事务资源。
     3. 反馈事务提交结果：参与者在完成事务提交后向协调者发送Ack消息。
     4. 完成事务：协调者接受所有参与者反馈的ack消息后，完成事务。

     中断事务：

     1. 协调者向所有参与者发送abort请求
     2. 参与者接受abort请求后，利用在precommti中保存的Undo信息执行回滚，并释放资源。
     3. 参与者回滚结果:完成回滚后，向协调者发送ack信息。
     4. 协调者收到所有的参与者ack消息后中断事务。

     在阶段三中可能无法即使接受来自协调者的doCommit或abort，参与者在等待超时后会继续进行事务提交。

   __优缺点__ ：三阶段提交降低了参与者的阻塞范围，并在出现单点故障后达成一致。但是如果参与者接收到preCommit消息后，若网络出现分区则可能导致数据不一致。

3. __PAXOS__:

   1. 问题描述：假设有一组可以提出提案的进程集合，对于一个一致性算法来说应当保证：

      1. 只有一个提案被接受
      2. 如果没有天被提出，那么也不会有提案被选中。
      3. 当一个提案被选中后，所有进程都应该可以获取被选中的信息。

      安全性（Safety）
